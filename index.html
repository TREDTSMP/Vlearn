<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VLearn</title>
<link rel="icon" type="image/png" href="Logo.png">
<style>
  /* ============ COLOR / FONT VARIABLES ============ */
  :root{
    --bg: #e6f5ff;
    --fg: #003a66;
    --muted: rgba(0,0,0,0.45);
    --accent: #0077cc;
    --nav-bg: rgba(255,255,255,0.9);
    --nav-fg: #001f3f;
    --dropdown-bg: #fff;
  }
  html,body{ height:100%; margin:0; padding:0; }
  body{ font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--fg); overflow:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

  /* full app */
  .app{ height:100vh; width:100vw; position:relative; }

  /* generic screen sections (loader/intro/rick/space) */
  .screen{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; z-index:5; }
  .hidden{ display:none !important; }

  /* --- LOADER --- */
  .loader-card{ width:86%; max-width:780px; padding:24px; border-radius:14px; backdrop-filter: blur(6px); background:rgba(255,255,255,0.84); box-shadow:0 18px 36px rgba(2,6,23,0.08); }
  .logo-title{ font-family: "Merriweather", serif; font-size:24px; color:var(--fg); margin:0 0 8px; }
  .loader-sub{ color:var(--muted); font-size:14px; margin-bottom:12px; }
  .loader-bar{ width:100%; height:12px; background: #e6f3fb; border-radius:8px; overflow:hidden; }
  .loader-bar .fill{ width:0; height:100%; background:linear-gradient(90deg,var(--accent), #7edbff); animation:fillAnim 4s linear forwards; border-radius:8px; }
  @keyframes fillAnim { from{width:0} to{width:100%} }

  /* theme control (top-right) */
  .theme-btn{ position:fixed; top:14px; right:14px; z-index:120; background:rgba(0,0,0,0.56); color:#fff; border:0; padding:10px 12px; border-radius:10px; cursor:pointer; display:flex; gap:8px; align-items:center; font-weight:700; }
  .theme-panel{ position:fixed; top:56px; right:14px; z-index:125; display:none; background:var(--nav-bg); color:var(--nav-fg); border-radius:10px; padding:10px; box-shadow:0 12px 28px rgba(0,0,0,0.12); min-width:220px; }
  .theme-panel button{ display:block; width:100%; padding:10px 12px; border:0; background:transparent; text-align:left; cursor:pointer; font-weight:700; border-radius:6px; margin:4px 0; color:var(--nav-fg); }
  .theme-panel button:hover{ background:rgba(0,0,0,0.04); }

  /* ================= INTRO (overlay) ================= */
  #intro {
    position:fixed;
    inset:0;
    width:100%;
    height:100vh;
    background:#0db24a;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    z-index:9999;
    overflow:hidden;
    pointer-events:auto;
  }

  /* center group containing Vs and welcome */
  .center-content { z-index:10000; text-align:center; pointer-events:none; }
  .v-wrapper { position:relative; width:min(680px,80vw); height:auto; display:flex; align-items:center; justify-content:center; }
  .bigV, .smallV {
    display:inline-block;
    line-height:1;
    font-family: "Merriweather", serif;
    font-weight:900;
    user-select:none;
    transform-origin:center center;
    will-change: transform, opacity;
  }
  .bigV { font-size:16vw; color:#000; }
  .smallV { font-size:7.8vw; color:#00ffff; position:absolute; left:50%; top:40%; transform:translate(-50%,-50%); }

  .welcome-text { margin-top:1.25rem; font-size:1.4rem; font-weight:700; color:#001f3f; opacity:0; transform:translateY(8px); transition:opacity .42s ease, transform .42s ease; }
  .welcome-visible { opacity:1; transform:translateY(0); }

  /* entry animations */
  @keyframes bigRise { 0% { transform: translateY(120vh) scale(.95) rotate(-8deg); opacity:0 } 70% { transform: translateY(0) scale(1.03) rotate(-2deg); opacity:1 } 100% { transform: translateY(0) scale(1) rotate(0); opacity:1 } }
  @keyframes smallDrop { 0% { transform: translateY(-120vh) scale(.8) rotate(8deg); opacity:0 } 70% { transform: translateY(6%) scale(1.06) rotate(2deg); opacity:1 } 100% { transform: translateY(0) scale(1) rotate(0); opacity:1 } }
  @keyframes lockPulse { 0%{ transform: scale(1) } 50%{ transform: scale(1.06) } 100%{ transform: scale(1) } }

  /* random geometric shapes */
  #shapesContainer { position:absolute; inset:0; z-index:9998; pointer-events:none; }
  .shape { position:absolute; z-index:9998; opacity:.55; transform-origin:center center; pointer-events:none; }
  .shape.circle { border-radius:50%; background:rgba(255,255,255,0.18); }
  .shape.square { background:rgba(255,255,255,0.18); }
  .shape.triangle { width:0; height:0; border-left:28px solid transparent; border-right:28px solid transparent; border-bottom:48px solid rgba(255,255,255,0.18); }

  /* ink splat overlay (multiple splats) */
  .splat { position:absolute; background:#062d6f; border-radius:50%; opacity:0; transform:translate(-50%,-50%) scale(0); z-index:10001; pointer-events:none; transition: transform 4s ease-in-out, opacity .9s ease; }
  .splat.grow { opacity:1; transform:translate(-50%,-50%) scale(40); }

  @media (prefers-reduced-motion: reduce) {
    .bigV, .smallV, .splat, .shape { animation: none !important; transition:none !important; opacity:1 !important; transform:none !important; }
    .welcome-text { opacity:1 !important; transform:none !important; }
  }

  /* --- RICKROLL --- */
  #rick{ position:fixed; inset:0; z-index:9997; background:#000; display:flex; align-items:center; justify-content:center; }
  #rick video{ width:100%; height:100%; object-fit:cover; }

  /* --- SPACE / STARFIELD --- */
  #space{ position:relative; inset:0; width:100%; height:100%; background:#000; color:#fff; overflow:hidden; display:flex; align-items:flex-start; justify-content:center; padding-top:18px; z-index:10; }
  canvas#stars{ position:absolute; inset:0; width:100%; height:100%; z-index:10; display:block; }

  /* ============ NAV BAR - pinned to TOP (user requested) ============ */
  .navbar {
    position:fixed;
    top:12px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    align-items:center;
    justify-content:space-between;
    background:var(--nav-bg);
    color:var(--nav-fg);
    border-radius:28px;
    overflow: visible;
    width:92%;
    max-width:1200px;
    padding:8px 12px;
    z-index:120;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  }
  .nav-left, .nav-right { display:flex; align-items:center; gap:8px; }
  .brand { font-weight:900; letter-spacing:0.6px; color:var(--nav-fg); text-decoration:none; padding:8px 12px; font-size:18px; }
  .nav-links{ list-style:none; display:flex; gap:6px; margin:0; padding:0; align-items:center; }
  .nav-links li{ position:relative; }
  .nav-links a, .nav-links button.dropbtn {
    color:var(--nav-fg); text-decoration:none; padding:10px 14px; border-radius:8px; background:transparent; border:0; font-weight:700; cursor:pointer;
  }
  .nav-links a:hover, .nav-links button.dropbtn:hover{ background: rgba(0,0,0,0.04); }
  .dropdown-content {
    display:none;
    position:absolute;
    top:calc(100% + 8px);
    left:0;
    background:var(--dropdown-bg);
    min-width:180px;
    box-shadow:0 10px 28px rgba(0,0,0,0.15);
    border-radius:8px;
    z-index:9999;
    overflow:hidden;
  }

  /* modal */
  .modal {
    position:fixed; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; z-index:200;
    background: rgba(0,0,0,0.45); visibility:hidden; opacity:0; transition:opacity .18s ease;
  }
  .modal.show{ visibility:visible; opacity:1; }

  h1,h2,h3,p{ margin:0; padding:0; }
</style>
</head>
<body>
<div id="app" class="app" aria-live="polite">
  <!-- Theme control -->
  <button class="theme-btn" id="themeBtn" aria-label="Theme selector">Theme</button>
  <div class="theme-panel" id="themePanel" role="dialog" aria-hidden="true">
    <div style="font-weight:900;margin-bottom:8px;">Choose theme</div>
    <button data-theme="dark">Dark</button>
    <button data-theme="light">Light</button>
    <button data-theme="retro">Retro DOS</button>
    <button data-theme="radio">Radioactive</button>
    <button data-theme="lava">Lava</button>
    <button data-theme="glitch">Glitched</button>
    <button data-theme="sgs">SGS</button>
  </div>

  <!-- Loading (4s) -->
  <section id="loading" class="screen" aria-hidden="false">
    <div class="loader-card" role="status">
      <div class="logo-title">VLearn</div>
      <div class="loader-sub">Loading the VLearn Directory — please wait</div>
      <div class="loader-bar" aria-hidden="true"><div class="fill"></div></div>
      <div class="loader-meta" style="margin-top:10px; color:var(--muted);">Preparing answers • Aligning chapters • Applying finishing touches</div>
    </div>
  </section>

  <!-- Intro overlay -->
  <section id="intro" class="hidden" aria-hidden="true" role="img" aria-label="VLearn intro animation">
    <div id="shapesContainer" aria-hidden="true"></div>

    <div class="center-content" aria-hidden="false">
      <div class="v-wrapper" id="vWrapper">
        <span class="bigV init" id="bigV">V</span>
        <span class="smallV init" id="smallV">V</span>
      </div>
      <div id="introText" class="welcome-text">Welcome to VLearn Web App</div>
    </div>

    <!-- ink splats pre-created -->
    <div class="splat" id="splat1" style="left:40%; top:30%; width:80px; height:80px;"></div>
    <div class="splat" id="splat2" style="left:75%; top:45%; width:60px; height:60px;"></div>
    <div class="splat" id="splat3" style="left:18%; top:68%; width:100px; height:100px;"></div>
    <div class="splat" id="splat4" style="left:55%; top:78%; width:70px; height:70px;"></div>
  </section>

  <!-- Rickroll (1s) -->
  <section id="rick" class="hidden" aria-hidden="true">
    <video id="rickVideo" src="rickroll.mp4" playsinline preload="auto"></video>
  </section>

  <!-- Space with starfield & nav bar -->
  <section id="space" class="screen hidden" aria-hidden="true">
    <div id="glitchBg" class="glitch-bg" style="display:none;"></div>
    <canvas id="stars"></canvas>

    <!-- NAV BAR -->
    <nav class="navbar" role="navigation" aria-label="Main navigation">
      <div class="nav-left">
        <a href="index.html" class="brand">VLEARN</a>

        <ul class="nav-links">
          <li class="dropdown">
            <button class="dropbtn">SUBJECTS ▾</button>
            <ul class="dropdown-content" id="subjectsDrop">
              <li><a href="hindi.html">Hindi</a></li>
              <li><a href="#" class="locked">English</a></li>
              <li><a href="#" class="locked">Maths</a></li>
              <li><a href="#" class="locked">Science</a></li>
              <li><a href="#" class="locked">SST</a></li>
            </ul>
          </li>

          <li><a href="#" >PRACTICE SHEET</a></li>
          <li><a href="#" >ANSWER KEY</a></li>
        </ul>
      </div>

      <div class="nav-right">
        <ul class="nav-links">
          <li><a href="copyright.html" >Copyright(c)</a></li>
          <li><a href="aboutus.html" >About Us</a></li>
          <li><a href="credits.html" >Credit</a></li>
        </ul>
      </div>
    </nav>

    <!-- page content that will host the retro iframe when Retro theme is active -->
    <div class="page-content-placeholder" id="pageContent" style="margin-top:86px;">
      <h2 style="font-size:22px; margin-bottom:10px; color:var(--nav-fg);">VLearn Directory</h2>
      <p style="color:var(--muted);">Choose a subject from the menu to continue. Locked items show a "Locked for now" message.</p>
    </div>
  </section>

  <!-- Locked modal -->
  <div class="modal" id="modalLocked" role="dialog" aria-modal="true">
    <div class="card">
      <h3 style="margin-bottom:8px;">LOCKED FOR NOW</h3>
      <p>COMING SOON</p>
      <button id="modalClose">OK</button>
    </div>
  </div>
</div>

<script>
/* ============ ORCHESTRATION & THEME + STARFIELD ============ */
(function(){
  // elements
  const loading = document.getElementById('loading');
  const intro = document.getElementById('intro');
  const rick = document.getElementById('rick');
  const space = document.getElementById('space');
  const rickVideo = document.getElementById('rickVideo');

  const bigV = document.getElementById('bigV');
  const smallV = document.getElementById('smallV');
  const introText = document.getElementById('introText');
  const shapesContainer = document.getElementById('shapesContainer');
  const splats = [ document.getElementById('splat1'), document.getElementById('splat2'), document.getElementById('splat3'), document.getElementById('splat4') ];

  // theme UI (kept as before)
  const themeBtn = document.getElementById('themeBtn');
  const themePanel = document.getElementById('themePanel');
  themeBtn.addEventListener('click', (e)=>{ e.stopPropagation(); themePanel.style.display = themePanel.style.display === 'block' ? 'none' : 'block'; });
  document.addEventListener('click', (e)=>{ if(themePanel.style.display === 'block' && !themePanel.contains(e.target) && e.target !== themeBtn) themePanel.style.display='none'; });

  // THEMES
  const THEMES = {
    dark: { '--bg':'#000000', '--fg':'#bfefff','--muted':'rgba(255,255,255,0.6)','--accent':'#6ee7ff', navBg:'rgba(0,0,0,0.76)', navFg:'#dff8ff', dropdown:'#111', spaceBg:'#000000', star:'#ffffff', starMoving:1, glitch:false },
    light: { '--bg':'#ffffff', '--fg':'#003a66','--muted':'rgba(0,0,0,0.45)','--accent':'#0077cc', navBg:'rgba(255,255,255,0.95)', navFg:'#003a66', dropdown:'#fff', spaceBg:'#ffffff', star:'#001f3f', starMoving:1, glitch:false },
    retro: { '--bg':'#001a33', '--fg':'#ffffff','--muted':'rgba(255,255,255,0.85)','--accent':'#66ffff', navBg:'rgba(0,26,51,0.92)', navFg:'#fff', dropdown:'#001a33', spaceBg:'#001a33', star:'#ffffff', starMoving:0.2, glitch:false },
    radio: { '--bg':'#d6ff7a','--fg':'#2f7f00','--muted':'rgba(0,0,0,0.35)','--accent':'#6bd400', navBg:'rgba(230,255,170,0.95)', navFg:'#164a00', dropdown:'#eaffb8', spaceBg:'#d6ff7a', star:'#2f7f00', starMoving:1, glitch:false },
    lava: { '--bg':'linear-gradient(180deg,#ffd84d,#ff7a00)','--fg':'#6b0000','--muted':'rgba(0,0,0,0.45)','--accent':'#ff6a00', navBg:'rgba(255,230,170,0.95)', navFg:'#6b0000', dropdown:'#ffe7b0', spaceBg:'#ffd84d', star:'#6b0000', starMoving:1, glitch:false },
    glitch: { '--bg':'#050406','--fg':'#e6f7ff','--muted':'rgba(255,255,255,0.6)','--accent':'#00ffff', navBg:'rgba(2,2,2,0.85)', navFg:'#e6f7ff', dropdown:'#070707', spaceBg:'glitch', starNeg:['#ffffff','#00ffff','#000000','#ff0000'], starMoving:0, glitch:true },
    sgs: { '--bg':'linear-gradient(180deg,#061235,#0b2b45)','--fg':'#ffffff','--muted':'rgba(255,255,255,0.85)','--accent':'#ffb86b', navBg:'rgba(6,18,53,0.9)', navFg:'#fff', dropdown:'#05213b', spaceBg:'#061235', star:'#ff8a3d', starMoving:1, glitch:false }
  };

  /* ============ RETRO BOX LOADER (moved early & hardened) ============ */
  function loadRetroBoxIntoContainer(containerElement) {
    if(!containerElement) return;
    try {
      // Save original HTML once (store as dataset)
      if(containerElement.dataset.vlearnOrig === undefined){
        containerElement.dataset.vlearnOrig = containerElement.innerHTML;
      }
      // clear and insert iframe
      containerElement.innerHTML = '';
      const iframe = document.createElement('iframe');
      // relative path; ensure retro-cmd.html is in same folder as index.html on the server
      iframe.src = 'retro-cmd.html';
      iframe.style.width = '100%';
      iframe.style.height = '100%';
      iframe.style.border = '0';
      iframe.style.borderRadius = '12px';
      iframe.setAttribute('title','ABS Retro CMD');
      containerElement.appendChild(iframe);

      // network/fail fallback: if iframe hasn't loaded after 2.5s, add small notice & log
      let loaded = false;
      const loadTimeout = setTimeout(()=> {
        if(!loaded){
          console.warn('retro iframe not signalled loaded yet (possible 404 or CSP).');
          const note = document.createElement('div');
          note.style.padding = '12px';
          note.style.color = '#fff';
          note.style.background = '#08162b';
          note.style.borderRadius = '10px';
          note.style.fontFamily = 'monospace';
          note.innerText = 'Failed to load retro-cmd.html — check file is present in site root and deploy. See console/network.';
          containerElement.appendChild(note);
        }
      }, 2500);

      iframe.addEventListener('load', ()=> {
        loaded = true;
        clearTimeout(loadTimeout);
        console.info('retro iframe loaded successfully:', iframe.src);
      });
      iframe.addEventListener('error', ()=> {
        console.error('retro iframe error loading:', iframe.src);
        clearTimeout(loadTimeout);
      });

    } catch(err){
      console.error('loadRetroBoxIntoContainer error', err);
    }
  }

  // apply theme (calls the loader for retro)
  function applyTheme(name){
    const cfg = THEMES[name] || THEMES.light;
    Object.keys(cfg).forEach(k=>{
      if(k.startsWith('--')) document.documentElement.style.setProperty(k, cfg[k]);
    });
    document.documentElement.style.setProperty('--nav-bg', cfg.navBg);
    document.documentElement.style.setProperty('--nav-fg', cfg.navFg);
    document.documentElement.style.setProperty('--dropdown-bg', cfg.dropdown || cfg.navBg);
    currentTheme = name;
    localStorage.setItem('vlearn-theme', name);
    if(!space.classList.contains('hidden')) restartStarfield();
    document.getElementById('glitchBg').style.display = cfg.glitch ? 'block' : 'none';

    // retro integration
    const container = document.getElementById('pageContent');
    if(!container) return;
    if(name === 'retro') {
      console.log('applyTheme: retro -> loading retro box into #pageContent');
      loadRetroBoxIntoContainer(container);
    } else {
      // restore original if saved
      if(container.dataset && container.dataset.vlearnOrig !== undefined){
        container.innerHTML = container.dataset.vlearnOrig;
        delete container.dataset.vlearnOrig;
      }
    }
  }

  /* ============ Hook theme panel buttons ============ */
  document.querySelectorAll('.theme-panel button').forEach(b => b.addEventListener('click', ()=> applyTheme(b.getAttribute('data-theme')) ) );

  let currentTheme = localStorage.getItem('vlearn-theme') || 'light';
  applyTheme(currentTheme);

  /* ============ STARFIELD (kept from original) ============ */
  const STAR_DENSITY = 4000;
  let starAnimationStop = null;
  function startStarfield(){ /* same as your working implementation - unchanged for brevity */ 
    stopStarfield();
    const cfg = THEMES[currentTheme] || THEMES.light;
    const canvas = document.getElementById('stars');
    if(!canvas) return;
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0,0,canvas.width,canvas.height);

    if(cfg.spaceBg === 'glitch'){ document.getElementById('glitchBg').style.display = 'block'; canvas.style.background = '#000'; }
    else { document.getElementById('glitchBg').style.display = 'none'; canvas.style.background = cfg.spaceBg || cfg.spaceBg; canvas.style.background = cfg.spaceBg; }

    const stars = [];
    if(cfg.glitch && Array.isArray(cfg.starNeg)){
      for(let i=0;i<STAR_DENSITY;i++){
        stars.push({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.6+0.6, color: cfg.starNeg[Math.floor(Math.random()*cfg.starNeg.length)], delay: Math.random()*1400 });
      }
      let raf;
      function loop(t){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        stars.forEach(s=>{
          const v = Math.abs(Math.sin((t + s.delay)*0.004 + s.r));
          if(v > 0.6){
            ctx.fillStyle = s.color;
            ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill();
          }
        });
        raf = requestAnimationFrame(loop);
      }
      raf = requestAnimationFrame(loop);
      starAnimationStop = ()=>{ cancelAnimationFrame(raf); ctx.clearRect(0,0,canvas.width,canvas.height); };
    } else if(cfg.starMoving && cfg.starMoving < 1){
      for(let i=0;i<STAR_DENSITY;i++){
        stars.push({ x:Math.random()*canvas.width, y:Math.random()*canvas.height, r:Math.random()*1.6+0.3 });
      }
      const id = setInterval(()=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);
        stars.forEach(s=>{
          s.x += (Math.random()-0.5)*3;
          s.y += (Math.random()-0.5)*3;
          if(s.x < 0) s.x = canvas.width; if(s.x > canvas.width) s.x = 0;
          if(s.y < 0) s.y = canvas.height; if(s.y > canvas.height) s.y = 0;
          ctx.fillStyle = cfg.star || '#fff';
          ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
        });
      }, 200);
      starAnimationStop = ()=>{ clearInterval(id); ctx.clearRect(0,0,canvas.width,canvas.height); };
    } else {
      for(let i=0;i<STAR_DENSITY;i++){
        stars.push({
          x:Math.random()*canvas.width,
          y:Math.random()*canvas.height,
          r:Math.random()*1.6+0.2,
          vx:(Math.random()*0.6-0.3)*(0.5+Math.random()*0.8),
          vy:(Math.random()*0.6-0.3)*(0.5+Math.random()*0.8),
          alpha: Math.random()*0.7+0.2,
          color: cfg.star || '#fff'
        });
      }
      let raf;
      function loop(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        stars.forEach(s=>{
          s.x += s.vx; s.y += s.vy;
          if(s.x < 0) s.x = canvas.width; if(s.x > canvas.width) s.x = 0;
          if(s.y < 0) s.y = canvas.height; if(s.y > canvas.height) s.y = 0;
          ctx.globalAlpha = s.alpha;
          ctx.fillStyle = s.color;
          ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,Math.PI*2); ctx.fill();
        });
        ctx.globalAlpha = 1;
        raf = requestAnimationFrame(loop);
      }
      raf = requestAnimationFrame(loop);
      starAnimationStop = ()=>{ cancelAnimationFrame(raf); ctx.clearRect(0,0,canvas.width,canvas.height); };
    }

    window.addEventListener('resize', ()=>{ canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
  }
  function stopStarfield(){ if(typeof starAnimationStop === 'function'){ try{ starAnimationStop(); }catch(e){} starAnimationStop = null; } }
  function restartStarfield(){ stopStarfield(); startStarfield(); }

  /* ============ NAV LOCKS & modal ============ */
  const modalLocked = document.getElementById('modalLocked');
  const modalClose = document.getElementById('modalClose');
  function showLocked(){ modalLocked.classList.add('show'); }
  modalClose && modalClose.addEventListener('click', ()=> modalLocked.classList.remove('show') );
  document.querySelectorAll('.locked').forEach(l => l.addEventListener('click', (ev)=>{ ev.preventDefault(); showLocked(); }) );

  /* ============ DROPDOWN CLICK/TAP SUPPORT ============ */
  (function(){
    document.querySelectorAll('.dropdown .dropbtn').forEach(btn=>{
      btn.addEventListener('click', function(e){
        e.preventDefault(); e.stopPropagation();
        const panel = btn.parentElement.querySelector('.dropdown-content');
        if(!panel) return;
        const isOpen = panel.style.display === 'block';
        document.querySelectorAll('.dropdown .dropdown-content').forEach(p => p.style.display = 'none');
        panel.style.display = isOpen ? 'none' : 'block';
      });
    });
    document.addEventListener('click', function(){ document.querySelectorAll('.dropdown .dropdown-content').forEach(p => p.style.display = 'none'); });
    document.addEventListener('keydown', function(e){ if(e.key === 'Escape') document.querySelectorAll('.dropdown .dropdown-content').forEach(p => p.style.display = 'none'); });
  })();

  /* ============ SEQUENCE: loading -> intro (7s) -> rick (1s) -> space ============ */
  loading.classList.remove('hidden'); intro.classList.add('hidden'); rick.classList.add('hidden'); space.classList.add('hidden');

  // show loader for 4s, then intro
  setTimeout(()=> {
    loading.classList.add('hidden');
    intro.classList.remove('hidden');
    runIntroSequence();
  }, 4000);

  function gotoRickThenSpace(){
    intro.classList.add('hidden');
    rick.classList.remove('hidden');
    (async ()=>{ try{ await rickVideo.play(); } catch(e){ try{ rickVideo.muted=true; await rickVideo.play(); }catch(e){} } })();
    setTimeout(()=> {
      try{ rickVideo.pause(); rickVideo.currentTime = 0; } catch(e){}
      rick.classList.add('hidden');
      space.classList.remove('hidden');
      applyTheme(currentTheme);
      try{ startStarfield(); } catch(e){}
    }, 1000);
  }

  /* ============ Intro animation timeline ============ */
  function runIntroSequence(){
    // reset
    bigV.style.animation = ''; smallV.style.animation = '';
    introText.classList.remove('welcome-visible');
    // shapes - create some random shapes
    createRandomShapes(10);
    // reset splats
    splats.forEach(s=>{ s.classList.remove('grow'); s.style.opacity = 0; s.style.transform = 'translate(-50%,-50%) scale(0)'; });

    // play V animations
    const bigStart = 120;
    const bigDuration = 900;
    const smallStart = 260;
    const smallDuration = 900;
    bigV.style.animation = `bigRise ${bigDuration}ms cubic-bezier(.2,.8,.2,1) ${bigStart}ms both`;
    smallV.style.animation = `smallDrop ${smallDuration}ms cubic-bezier(.2,.8,.2,1) ${smallStart}ms both`;

    // after they land, quick lock pulse
    const lockDelay = Math.max(bigStart + bigDuration, smallStart + smallDuration) + 120;
    setTimeout(()=> {
      const wrapper = document.getElementById('vWrapper');
      wrapper && wrapper.classList.add('merged');
      setTimeout(()=> wrapper && wrapper.classList.remove('merged'), 360);
    }, lockDelay);

    // show welcome text shortly after lock
    setTimeout(()=> introText.classList.add('welcome-visible'), lockDelay + 240);

    // schedule splat growth: start at 3000ms (so splats grow 4s and finish at 7000ms)
    const splatStart = 3000;
    const splatGrowDuration = 4000;
    setTimeout(()=> {
      splats.forEach((s, idx) => {
        setTimeout(()=> {
          s.style.transition = `transform ${splatGrowDuration}ms ease-in-out, opacity ${Math.min(900, splatGrowDuration/3)}ms ease`;
          s.classList.add('grow');
        }, idx * 140);
      });
    }, splatStart);

    // after 7s (intro total) go to rick
    setTimeout(()=> {
      gotoRickThenSpace();
    }, 7000);
  }

  // helper: create random shapes (triangle/circle/square) and place them
  function createRandomShapes(count){
    shapesContainer.innerHTML = '';
    const types = ['circle','square','triangle'];
    for(let i=0;i<count;i++){
      const el = document.createElement('div');
      const t = types[Math.floor(Math.random()*types.length)];
      el.classList.add('shape', t);
      const scale = 0.5 + Math.random()*2.2;
      if(t === 'triangle'){
        el.style.width = '0'; el.style.height = '0';
        el.style.borderLeft = `${10*scale}px solid transparent`;
        el.style.borderRight = `${10*scale}px solid transparent`;
        el.style.borderBottom = `${20*scale}px solid rgba(255,255,255,0.18)`;
      } else {
        const size = Math.round((20 + Math.random()*120) * scale);
        el.style.width = `${size}px`;
        el.style.height = `${size}px`;
        if(t === 'circle') el.style.borderRadius = '50%';
      }
      el.style.left = `${Math.random() * 100}vw`;
      el.style.top = `${Math.random() * 100}vh`;
      el.style.transform = `rotate(${Math.floor(Math.random()*360)}deg) scale(${0.6 + Math.random()*1.0})`;
      shapesContainer.appendChild(el);
    }
  }

  // expose for dev
  window.runIntroSequence = runIntroSequence;

  // clean up on unload
  window.addEventListener('beforeunload', ()=> { try{ stopStarfield(); } catch(e){} });

})();
</script>
</body>
</html>
