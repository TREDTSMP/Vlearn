<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ABS Search Engine </title>
<link rel="icon" type="image/png" href="Logo.png">
<style>
  :root{
    --bg:#0000FF; /* dark blue background for the retro box */
    --fg:#fff;    /* white text for retro CMD / BSOD */
    --mono: "Courier New", Courier, monospace;
  }
  html,body{height:100%;margin:0;font-family:var(--mono);background:var(--bg);color:var(--fg);-webkit-font-smoothing:antialiased;}
  .container{box-sizing:border-box;padding:18px;height:100%;display:flex;flex-direction:column;gap:12px;}
  .title{font-weight:900;font-size:20px;margin-bottom:6px;color:#fff;}
  .search-area{display:flex;flex-direction:column;align-items:center;gap:10px;}
  .engine-name{font-size:22px;font-weight:900;letter-spacing:1px;color:#fff;margin-bottom:6px;}
  .search-box{width:60%;min-width:240px;max-width:760px;display:flex;gap:8px;align-items:center;}
  input[type="text"]{flex:1;padding:10px 12px;border-radius:6px;border:0;background:#07202a;color:#fff;font-size:16px;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}
  button{padding:10px 12px;border-radius:6px;border:0;background:#184e67;color:#fff;font-weight:700;cursor:pointer}
  .hint{font-size:13px;color:rgba(255,255,255,0.78);}

  .cmd-window{flex:1;overflow:auto;background:rgba(0,0,0,0.18);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.06);font-size:14px;line-height:1.45;}
  .line{white-space:pre-wrap;}
  .prompt{color:#9be6ff;}
  .muted{color:rgba(255,255,255,0.72);font-size:13px}
  .btn-row{display:flex;gap:8px;align-self:center;margin-top:6px}

  /* BSOD overlay (full iframe) */
  .bsod{
    position:fixed;inset:0;background:#0000FF;color:#ffffff;display:flex;flex-direction:column;align-items:flex-start;justify-content:center;padding:28px;font-family:var(--mono);font-size:16px;line-height:1.6;z-index:9999;
    display:none;
  }
  .bsod .big{font-weight:700;margin-bottom:12px;font-size:18px}
  .hacker{
    position:fixed;inset:0;background:#000;color:#33ff33;font-family:monospace;padding:18px;overflow:auto;display:none;z-index:10000;font-size:13px;line-height:1.35;
  }

  /* Admin Simulator modal (integrated) */
  .admin-modal {
    position: fixed;
    inset: 0;
    display: none;
    background: rgba(0,0,0,0.75);
    z-index: 20000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .admin-panel {
    width: 92%;
    max-width: 1200px;
    height: 86%;
    max-height: 820px;
    background: #001100;
    border-radius: 10px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    padding: 14px;
    display:flex;
    flex-direction:column;
  }
  .admin-header { display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .admin-log { flex:1; overflow:auto; background:#001100; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); font-family:var(--mono); color:var(--fg);}
  .admin-controls { display:flex; gap:8px; margin-top:10px; align-items:center; }
  .admin-choices { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .admin-choice { background:#003300; padding:6px 8px; border-radius:6px; cursor:pointer; color:var(--fg); }
  .admin-small { font-size:12px; color:#9be6ff; }

  .control { display:flex; gap:8px; align-items:center; }
  .exit-btn { background:#9b1b1b; }

  /* small helpers */
  .small-note{font-size:12px;color:rgba(255,255,255,0.6)}
  .centered{display:flex;justify-content:center;align-items:center}
</style>
</head>
<body>
  <div class="container" role="application" aria-label="ABS Retro Search and CMD">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
      </div>
      <!-- small exit button -->
      <div class="control">
        <button id="closeBox" class="exit-btn" title="Close box" onclick="window.location.href='index.html'">
  Exit Box
</button>
      </div>
    </div>

    <!-- Search engine UI -->
    <div class="search-area" aria-hidden="false">
      <div class="engine-name">ABS Search Engine</div>
      <div class="search-box" role="search">
        <input id="searchInput" type="text" placeholder="Type search or command (help / connect / call / call.admin1 / exit)" aria-label="Search or command">
        <button id="goBtn">SEARCH</button>
      </div>
      <div class="hint">Welcome to the ABS. Good luck web browsing.</div>
    </div>

    <!-- Command like text output area -->
    <div id="cmdWindow" class="cmd-window" role="log" aria-live="polite"></div>

    <div class="btn-row centered">
      <button id="connectBtn">CONNECT TO INTERNET</button>
      <button id="cmdBtn">OPEN CMD</button>
      <button id="helpBtn">HELP</button>
    </div>
  </div>

  <!-- BSOD overlay -->
  <div id="bsod" class="bsod" role="alert" aria-hidden="true">
    <div class="big">A problem has been detected and your device has been shut down to prevent damage to your device.</div>
    <div class="line">*** STOP: 0x16DB0581 (0x6EA1A9E2 0x3EFA79EA 0x8BCA6919)</div>
    <div class="line">*** gv3.sys</div>
    <div class="line">Address F86B5A89 base at F86B5000, DateStamp 3DDD991EB</div>
    <div style="height:18px"></div>
    <div class="line">Collecting data for crash dump... Initializing data for crash dump. Beginning dump of physical memory</div>
    <div class="line">Physical memory dump complete: 100</div>
    <div style="height:18px"></div>
    <div class="line">Contact your system administrator.</div>
  </div>

  <!-- Hacker simulation -->
  <div id="hacker" class="hacker" aria-hidden="true"></div>

  <!-- Admin Simulator Modal -->
  <div id="adminModal" class="admin-modal" role="dialog" aria-hidden="true" aria-label="Admin Simulator">
    <div class="admin-panel" role="document">
      <div class="admin-header">
        <div>
          <strong style="font-size:14px">retro-cmdarg — Admin Call Simulator</strong>
          <div class="admin-small">Audio: static.mp3 (static), hangup.mp3 (hangup), morse.wav (spinner) — put them beside this file.</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="adminEnableAudio" class="btn">Enable Audio</button>
          <button id="adminSaveLog" class="btn">Save Log</button>
          <button id="adminClearLog" class="btn">Clear</button>
          <button id="adminClose" class="exit-btn">Close</button>
        </div>
      </div>

      <main id="adminLog" class="admin-log" role="log" aria-live="polite"></main>

      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <input id="adminCmdInput" type="text" placeholder="Type admin command (call.admin | call.admin1 | retrieve.signal | open signal.cache --sector Δ-47 | activate.beacon | decode.heliotrope)" style="flex:1;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#002200;color:var(--fg);font-family:var(--mono)">
        <button id="adminRunBtn" class="btn">Run</button>
      </div>

      <div id="adminChoices" class="admin-choices" aria-hidden="true"></div>
    </div>
  </div>

<script>
(function(){
  /* -------------------------
     Main page variables & UI
     ------------------------- */
  const cmdWindow = document.getElementById('cmdWindow');
  const searchInput = document.getElementById('searchInput');
  const goBtn = document.getElementById('goBtn');
  const connectBtn = document.getElementById('connectBtn');
  const cmdBtn = document.getElementById('cmdBtn');
  const helpBtn = document.getElementById('helpBtn');
  const closeBox = document.getElementById('closeBox');
  const bsod = document.getElementById('bsod');
  const hacker = document.getElementById('hacker');

  function appendLine(text, cls){
    const el = document.createElement('div');
    el.className = 'line' + (cls ? ' ' + cls : '');
    el.textContent = text;
    cmdWindow.appendChild(el);
    cmdWindow.scrollTop = cmdWindow.scrollHeight;
  }

  function waitMs(ms){ return new Promise(r=> setTimeout(r, ms)); }

  // show help
  function showHelp(){
    appendLine('Available commands: help | connect | call | call.admin | call.admin1 | exit', 'muted');
    appendLine('');
    appendLine('help -> show this list');
    appendLine('connect -> simulate connection to WWW via Bhutan DNS (23s)');
    appendLine('call -> simulate dialing Bhutan DNS Server Management');
    appendLine('call.admin or call.admin <any> -> open admin modal (admin unavailable flow)');
    appendLine('call.admin1 -> open admin modal (Admin1 interactive story)');
    appendLine('exit -> close the CMD (click button too)');
    appendLine('');
  }

  /* -------------------------
     simulateConnect
     ------------------------- */
  async function simulateConnect() {
    cmdWindow.innerHTML = '';
    appendLine('>>>connect', 'prompt');
    appendLine('SYSTEM: Initiating connection sequence to WWW via Bhutan DNS Server (203.0.113.5)');
    await waitMs(1000);

    appendLine('SYSTEM: DNS lookup...');
    appendLine('\tquery: internetexplorer.exe');
    await waitMs(3000); // 3 secs

    appendLine('\treply: 203.0.113.10');
    appendLine('SYSTEM: Opening secure tunnel...');
    appendLine('\ttunnel: W-TLS v1');
    appendLine('\tcipher suite: TLS_AES_256_GCM_SHA384');
    await waitMs(5000); // 5 secs

    appendLine('SYSTEM: TLS handshake...');
    appendLine('\tClientHello -> ServerHello -> Certificate -> KeyExchange -> Finished');
    appendLine('\tHandshake status: SUCCESS');
    await waitMs(4000); // 4 secs

    appendLine('SYSTEM: DHCP (simulated)');
    appendLine('\tAssigned IP: 203.0.113.45');
    appendLine('\tSubnet: 203.0.113.0/24');
    appendLine('\tGateway: 203.0.113.1');
    await waitMs(5000); // 5 secs

    appendLine('SYSTEM: Verifying route');
    appendLine('\t1  203.0.113.1    1 ms YOUR IP');
    appendLine('\t2  198.51.100.2  12 ms');
    appendLine('\t3  198.51.100.9  28 ms');
    appendLine('\t4  203.0.113.10  36 ms  DEST');
    await waitMs(4000); // 4 secs

    appendLine('SYSTEM:');
    appendLine('\tALPN: h2');
    appendLine('\tHTTP/2 streams: initialized');
    appendLine('\tTLS session ID: 4f3a-9b2c-77aa');
    await waitMs(1000); // 1 sec

    appendLine('SYSTEM: STATUS: CONNECTED!');
    appendLine('');
    appendLine('Total time taken: 23 secs.', 'muted');

    // After the connected output we simulate a crash after 1 second (the "search crashes in 5 sec")
    await waitMs(5000);
    triggerCrashSequence();
  }

  /* -------------------------
     simulateCall (17s spinner + morse sound)
     ------------------------- */
  async function simulateCall(){
    cmdWindow.innerHTML = '';
    appendLine('>>>call', 'prompt');
    appendLine('SYSTEM: Dialing Bhutan DNS Server Management Authority... 203.0.113.5');
    await waitMs(1200);
    appendLine('SYSTEM: Connecting... Ringing.');
    await waitMs(1800);
    appendLine('\tConnected to: Bhutan DNS Server Management Authority (203.0.113.5)');
    appendLine('\tAttempting to reach: Admin (on-duty)');
    await waitMs(1200);

    // spinner sound
    const audio = new Audio('morse.wav'); // must exist
    audio.volume = 0.6;
    audio.play().catch(err => console.log('Audio playback failed:', err));

    appendLine('SYSTEM: Connection established. Running remote diagnostics...');
    const spinnerLine = document.createElement('div');
    spinnerLine.className = 'line muted';
    spinnerLine.textContent = 'Processing... |';
    cmdWindow.appendChild(spinnerLine);

    const spinnerChars = ['|', '/', '-', '\\'];
    let i = 0;
    const spinInterval = setInterval(()=>{
      spinnerLine.textContent = 'Processing... ' + spinnerChars[i++ % spinnerChars.length];
      cmdWindow.scrollTop = cmdWindow.scrollHeight;
    }, 150);

    await waitMs(17000);
    clearInterval(spinInterval);
    spinnerLine.textContent = 'Processing... DONE ✓';
    audio.pause();
    audio.currentTime = 0;
    await waitMs(800);

    appendLine('SYSTEM: Status: ADMIN UNAVAILABLE');
    appendLine('\tAuto-response: "All agents are currently busy or offline. Please try again later."');
    appendLine('');
    appendLine('Click the Exit button to exit the call program.');
  }

  /* Crash / hacker sequences unchanged */
  function triggerCrashSequence(){
    // Show BSOD overlay (full iframe)
    bsod.style.display = 'flex';
    bsod.setAttribute('aria-hidden','false');

    // keep BSOD for 3s then show hacker text for 5s then return to prompt
    setTimeout(()=> {
      bsod.style.display = 'none';
      bsod.setAttribute('aria-hidden','true');
      showHackerSimulation();
    }, 3000);
  }

  function showHackerSimulation(){
    hacker.innerHTML = '';
    hacker.style.display = 'block';
    hacker.setAttribute('aria-hidden','false');

    const hackerText = `... (truncated for brevity in main view) ...`; // long block omitted here; original code can be restored
    // To keep page shorter I'll reuse the same streaming approach as your original file:
    const parts = hackerText.split('\n');
    let idx = 0;
    const totalMs = 6000;
    const interval = Math.max(20, Math.floor(totalMs / Math.max(1, parts.length)));
    const t = setInterval(()=> {
      if(idx < parts.length){
        const ln = document.createElement('div');
        ln.textContent = parts[idx++];
        hacker.appendChild(ln);
        hacker.scrollTop = hacker.scrollHeight;
      } else {
        clearInterval(t);
      }
    }, interval);

    setTimeout(()=> {
      hacker.style.display = 'none';
      hacker.setAttribute('aria-hidden','true');
      cmdWindow.innerHTML = '';
      appendLine('SYSTEM: Returned to CMD. You may type help for commands.', 'muted');
    }, totalMs + 200);
  }

  /* Open main CMD */
  function openCmd(){
    cmdWindow.innerHTML = '';
    appendLine('ABSOS.[Version 13.12.2009.9.03.2009]');
    appendLine('(c) ABS Co. All rights reserved.');
    appendLine('');
    appendLine('Type commands: help, connect, call, call.admin, call.admin1, exit');
    appendLine('');
    searchInput.focus();
  }

  /* Wire main UI */
  goBtn.addEventListener('click', async ()=>{
    const val = (searchInput.value || '').trim();
    if(!val) {
      appendLine('>>> (search) (no input)');
      appendLine('SYSTEM: Loading search results...');
      setTimeout(()=> triggerCrashSequence(), 1000);
      return;
    }
    const lc = val.toLowerCase();
    if(lc === 'help'){ showHelp(); }
    else if(lc === 'connect'){ simulateConnect(); }
    else if(lc === 'call'){ simulateCall(); }
    else if(lc === 'exit'){ requestCloseToParent(); }
    else if(lc.startsWith('call.admin')) {
      // open admin modal and run admin command
      openAdminModal();
      adminSim.handleCommand(lc);
    } else {
      appendLine('>>> ' + val, 'prompt');
      appendLine('ABS Search: processing...');
      setTimeout(()=> triggerCrashSequence(), 1000);
    }
  });
  searchInput.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ goBtn.click(); } });
  connectBtn.addEventListener('click', ()=> simulateConnect());
  cmdBtn.addEventListener('click', ()=> openCmd());
  helpBtn.addEventListener('click', ()=> showHelp());
  closeBox.addEventListener('click', ()=> requestCloseToParent());
  function requestCloseToParent(){
    try{ parent.postMessage({type:'retro-close'}, '*'); }catch(e){}
  }

  // auto-open cmd when loaded
  openCmd();

  /* -------------------------
     Admin Simulator (namespaced) integrated
     ------------------------- */
  const adminModal = document.getElementById('adminModal');
  const adminLog = document.getElementById('adminLog');
  const adminCmdInput = document.getElementById('adminCmdInput');
  const adminRunBtn = document.getElementById('adminRunBtn');
  const adminChoices = document.getElementById('adminChoices');
  const adminEnableAudio = document.getElementById('adminEnableAudio');
  const adminSaveLog = document.getElementById('adminSaveLog');
  const adminClearLog = document.getElementById('adminClearLog');
  const adminClose = document.getElementById('adminClose');

  const adminSim = (function(){
    // audio
    const sounds = {
      static: new Audio('static.mp3'),
      hangup: new Audio('hangup.mp3'),
    };
    sounds.static.volume = 0.6;
    sounds.hangup.volume = 0.9;
    let audioEnabled = false;

    function enableAudio(){
      audioEnabled = true;
      Object.values(sounds).forEach(a => { a.pause(); a.currentTime = 0; });
      adminEnableAudio.textContent = 'Audio Enabled';
      adminEnableAudio.disabled = true;
    }
    adminEnableAudio.addEventListener('click', enableAudio);

    function append(text, cls){
      const d = document.createElement('div');
      d.className = 'line' + (cls ? ' ' + cls : '');
      d.textContent = text;
      adminLog.appendChild(d);
      adminLog.scrollTop = adminLog.scrollHeight;
    }

    function waitMs(ms){ return new Promise(r => setTimeout(r, ms)); }

    function computeDelayForText(text){
      const words = text.split(/\s+/).filter(Boolean).length;
      const perWord = 350 + Math.floor(Math.random()*100);
      const base = 200;
      return base + words * perWord;
    }

    function playSound(name, opts = {}){
      if(!audioEnabled) return Promise.resolve();
      const a = sounds[name];
      if(!a) return Promise.resolve();
      a.loop = !!opts.loop;
      a.currentTime = 0;
      return a.play().catch(e => console.warn('Audio play failed', e));
    }
    function stopSound(name){
      const a = sounds[name];
      if(!a) return;
      a.pause(); a.currentTime = 0; a.loop = false;
    }

    // choices rendering
    async function presentChoices(options, callback){
      adminChoices.innerHTML = '';
      adminChoices.setAttribute('aria-hidden', 'false');
      for(const o of options){
        const b = document.createElement('button');
        b.className = 'admin-choice';
        b.textContent = o.label;
        b.onclick = () => {
          adminChoices.innerHTML = '';
          adminChoices.setAttribute('aria-hidden', 'true');
          callback(o.id);
        };
        adminChoices.appendChild(b);
      }
    }

    // helper line
    async function line(text, cls, opts = {}){
      if(opts.preSound) await playSound(opts.preSound);
      if(text.includes('[static]') || opts.tag === 'static'){
        const parts = text.split('[static]');
        append(parts[0], cls);
        await playSound('static', {loop:true});
        await waitMs(1200);
        stopSound('static');
        if(parts[1]) append(parts[1], cls);
      } else {
        append(text, cls);
      }
      await waitMs(opts.waitAfterOverride ?? computeDelayForText(text));
    }

    // core flows (copied & adapted from retro-cmdarg)
    async function runCallAdmin(targetName = 'Bhutan DNS Server Management Authority... 203.0.113.5'){
      adminChoices.innerHTML = '';
      adminChoices.setAttribute('aria-hidden', 'true');
      adminLog.innerHTML = '';
      append('>>>call.admin', 'prompt');
      append(`SYSTEM: Dialing ${targetName}`);
      append('SYSTEM: Connecting... Ringing.');
      append('\tConnected to: ' + targetName);
      append('\tAttempting to reach: Admin (on-duty)');
      append('SYSTEM: Connection established. Running remote diagnostics...');
      // spinner 17s (no sound here)
      const spinnerLine = document.createElement('div');
      spinnerLine.className = 'line muted';
      spinnerLine.textContent = 'Processing... |';
      adminLog.appendChild(spinnerLine);
      adminLog.scrollTop = adminLog.scrollHeight;
      const spinnerChars = ['|','/','-','\\']; let sIdx=0;
      const si = setInterval(()=>{ spinnerLine.textContent = 'Processing... ' + spinnerChars[sIdx++ % spinnerChars.length]; adminLog.scrollTop = adminLog.scrollHeight; }, 150);
      await waitMs(17000);
      clearInterval(si);
      spinnerLine.textContent = 'Processing... DONE ✓';
      await waitMs(600);
      append('SYSTEM: Status: ADMIN UNAVAILABLE');
      append('\tAuto-response: "All agents are currently busy or offline. Please try again later."');
      append('');
      append('Click Close to exit the admin simulator.');
      // short static + hangup
      await playSound('static', {loop:true});
      await waitMs(800);
      stopSound('static');
      await playSound('hangup');
    }

    // Admin1 long interactive flow (trimmed where safe but faithful)
    async function runCallAdmin1(){
      adminChoices.innerHTML = '';
      adminChoices.setAttribute('aria-hidden', 'true');
      adminLog.innerHTML = '';
      // sequence
      await line('>>>call.admin1', 'prompt');
      await line('SYSTEM: Dialing Chekya-Byas Россия DNS Server Management Authority... 198.0.10.5');
      await line('SYSTEM: Connecting... Ringing.');
      await line('\tConnected to: Chekya-Byas Россия DNS Server Management Authority (198.0.10.5)');
      await line('\tAttempting to reach: Admin1');
      await line('SYSTEM: Connection established. Running remote diagnostics...');
      // short spinner
      const spinnerLine = document.createElement('div'); spinnerLine.className='line muted'; spinnerLine.textContent='Processing... |'; adminLog.appendChild(spinnerLine);
      const spinnerChars = ['|','/','-','\\']; let sIdx=0;
      const si = setInterval(()=>{ spinnerLine.textContent = 'Processing... ' + spinnerChars[sIdx++ % spinnerChars.length]; adminLog.scrollTop = adminLog.scrollHeight; }, 160);
      await waitMs(3000); clearInterval(si); spinnerLine.textContent='Processing... DONE ✓';
      await line('SYSTEM: Status: ADMIN AVAILABLE', 'muted');
      await line('SYSTEM: STATUS: CONNECTED TO ADMIN1', 'muted');
      await line('SYSTEM: YOU ARE CONNECTED TO ADMIN1', 'muted');
      await line('admin1: I am the Administrator of the ABS Dominion, stationed at Mt. Kharichai Facility, Northern Sector.', null);
      await line('admin1: How may I assist you?', null);

      // present 3 options
      await presentChoices([
        {id:'opt_net_online', label:'[1] ONLINE'},
        {id:'opt_net_isolated', label:'[2] ISOLATED'},
        {id:'opt_net_unknown', label:'[3] UNKNOWN'}
      ], async (choiceId) => {
        if(choiceId === 'opt_net_online'){
          await line('user: [1] ONLINE', 'prompt', {waitAfterOverride:300});
          await line('admin1: Good. That means the physical layer is active. Now, initiating a virtual handshake with Bhutan DNS relay...', null);
          append('SYSTEM: Handshake in progress... SUCCESS ✓', 'muted'); await waitMs(800);
          append('admin1: Excellent. Your system’s now paired to the DNS node. That’s one less machine in the dark.', null);
          await continueAfterHandshake();
        } else if(choiceId === 'opt_net_isolated'){
          await line('user: [2] ISOLATED', 'prompt', {waitAfterOverride:300});
          await line('admin1: That complicates things...', null);
          await line('admin1: Wait — I\'m sending a fallback ping signal from my console... response?', null);
          append('SYSTEM: No response detected.', 'muted'); await waitMs(800);
          await line('admin1: I feared that. The isolation fields here affect low-frequency relays too. Let\'s reroute through my proxy in Kharichai...', null);
          append('SYSTEM: Alternate route established (ping stable).', 'muted'); await waitMs(600);
          await line('admin1: We’re back online. Proceeding.', null);
          await continueAfterHandshake();
        } else {
          await line('user: [3] UNKNOWN', 'prompt', {waitAfterOverride:300});
          await line('admin1: Unknown status? That’s odd. It might be interference — these mountains radiate static from old reactors.', null);
          await line('admin1: Hold on... running silent diagnostics.', null); append('SYSTEM: Interface restored. Status: ONLINE.', 'muted');
          await waitMs(600);
          await line('admin1: Better. Proceeding now.', null);
          await continueAfterHandshake();
        }
      });

      async function continueAfterHandshake(){
        append('SYSTEM: Bhutan DNS connection established ✓', 'muted');
        await waitMs(400);
        await line('admin1: ...', null, {waitAfterOverride:600});
        await line('admin1: You should disconnect soon — the radiation storms here are flaring again. The instruments... they hum louder every hour.', null);
        await line('user: What’s happening there?', 'prompt');
        await line('admin1: (pause) It’s classified. But you deserve to know something.', null);
        await line('admin1: I wasn’t always here. I worked in the core labs of the ABS Dominion — then they sent me north, against my will. They said it was "for security."', null);

        // next choices
        await presentChoices([
          {id:'ask_who', label:'[1] Ask: Who are “they”?'},
          {id:'ask_what', label:'[2] Ask: What are they doing in Mt. Kharichai?'},
          {id:'stay_silent', label:'[3] Stay silent.'}
        ], async (cid)=>{
          if(cid==='ask_who'){
            await line('user: [1] Who are "they"?','prompt');
            await line('admin1: The Dominion Council — the ones who built the ABSF Grid. They run everything from behind mirrored glass. Their guards... the Watchers... they never sleep.', null);
          } else if(cid==='ask_what'){
            await line('user: [2] What are they doing in Mt. Kharichai?','prompt');
            await line('admin1: Experimenting. With energy they can’t control. Radiation leaks through the snowfields... it twists metal, burns airwaves.', null);
          } else {
            await line('user: [3] Stay silent.','prompt');
            await line('admin1: You don’t have to ask. I can feel your questions. They listen for sound. Best we stay quiet.', null);
          }

          await waitMs(400);
          await line('admin1: Listen carefully. The Bhutan DNS link is stable now. But I... I can’t hold this channel long. If I send you coordinates, will you receive them?', null);

          await presentChoices([
            {id:'coord_yes', label:'[1] Yes, send them.'},
            {id:'coord_no', label:'[2] I’m not sure it’s safe.'},
            {id:'coord_who', label:'[3] Who’s watching you?'}
          ], async (choice)=>{
            if(choice==='coord_yes'){
              await line('user: [1] Yes, send them.','prompt');
              await line('admin1: Sending coordinates... 62°N, 58°E — the old sub-station under the frozen lake.', null);
              await line('admin1: If I go silent... follow the static. It leads to the truth.', null);
              await afterCoords();
            } else if(choice==='coord_no'){
              await line('user: [2] I’m not sure it’s safe.','prompt');
              await line('admin1: Safety doesn’t exist here anymore. Only the hum of the old servers... and the guards walking above me.', null);
              await afterCoords();
            } else {
              await line('user: [3] Who’s watching you?','prompt');
              await line('admin1: The Watchers — the ABSF guards. They patrol with old Geiger rifles... they think the radiation keeps us obedient.', null);
              await afterCoords();
            }
          });
        });
      }

      async function afterCoords(){
        await line('admin1: The Bhutan DNS link is stable now. But I... I can’t hold this channel long. If I send you coordinates, will you receive them?', null, {waitAfterOverride:600});
        await waitMs(300);
        await presentChoices([
          {id:'ask_more', label:'[1] Ask more (Who/What/Stay silent)'},
          {id:'get_signal', label:'[2] Wait for coordinates / request retrieval later'},
          {id:'end_session', label:'[3] End session now'}
        ], async (cid) => {
          if(cid==='ask_more'){
            append('admin1: I already gave you what I can — choose another option in the prompts earlier or wait for me to send the fragment.', null);
          } else if(cid==='get_signal'){
            append('SYSTEM: Awaiting user action. You can run: retrieve.signal or open signal.cache --sector Δ-47 later', 'muted');
            await waitMs(2200);
            await line('admin1: ...', null, {waitAfterOverride:500});
            await playSound('static', {loop:true});
            append('admin1: (whispering) If they trace this call, they’ll—', null);
            await waitMs(850);
            stopSound('static');
            append('[ALARM SIREN IN BACKGROUND]', 'muted');
            await line('SYSTEM: Remote connection signal degrading...', 'muted');
            await line('admin1: (shouting) They found me! The light — it’s breaking the—', null);
            await playSound('static', {loop:true}); await waitMs(800); stopSound('static'); await playSound('hangup');
            append('SYSTEM: Link terminated. Signal origin — Mt. Kharichai', 'muted');
            append('SYSTEM: ERROR: Remote admin disconnected unexpectedly.', 'muted');
            append('SYSTEM: Attempting reconnection... FAILED', 'muted');
            append('SYSTEM: Session closed.', 'muted');
            append('');
            append('>>> SYSTEM MESSAGE:');
            append('Connection to Admin1 lost.', 'muted');
            append('Last transmission: "...the light — it\'s breaking the..."', 'muted');

            await presentChoices([
              {id:'save_log', label:'[1] Yes, save log'},
              {id:'erase_log', label:'[2] No, erase everything'},
              {id:'retry_conn', label:'[3] Retry connection (warning: unstable)'}
            ], async (opt) => {
              if(opt === 'save_log'){
                append('SYSTEM: Writing recovered files to /local/cache/secure/operation_kharichai/', 'muted');
                append('SYSTEM: Files saved.', 'muted');
              } else if(opt === 'erase_log'){
                append('SYSTEM: Local cache erased. No artifacts stored.', 'muted');
              } else {
                append('SYSTEM: Reconnection attempt queued (unstable).', 'muted');
              }
              append('SYSTEM: Next available command: retrieve.signal', 'muted');
            });
          } else {
            append('SYSTEM: Session ended per user request.', 'muted');
            await playSound('hangup');
          }
        });
      }
    } // end runCallAdmin1

    // retrieve.signal flow
    async function retrieveSignal(){
      append('>>> retrieve.signal','prompt');
      append('SYSTEM: Scanning residual frequencies from last Admin1 session...', 'muted');
      await waitMs(800);
      append('SYSTEM: Searching Mt. Kharichai relay bands 203-209 MHz...', 'muted');
      await progressBar('.............SIGNAL FRAGMENT FOUND ✓', 1200);
      append('SYSTEM: Attempting decryption / re-synchronization...', 'muted');
      await waitMs(900);
      append('SYSTEM: Voice channel restored (unstable)', 'muted');
      append('admin1 (weak signal): —you heard me…? If so… this means the backup node under the lake still breathes.', null);
      append('admin1: static rising ≈ 47 %', 'muted');
      append('admin1: They shut down the main towers… I am below them now… the ice is cracking above the dome.', null);
      append('SYSTEM: Awaiting user input. Options: [1] Confirm connection stable  [2] Ask what happened  [3] Stay silent', 'muted');

      await presentChoices([
        {id:'sig_confirm', label:'[1] Confirm connection is stable'},
        {id:'sig_ask', label:'[2] Ask what happened to him'},
        {id:'sig_listen', label:'[3] Stay silent and listen'}
      ], async (id)=>{
        if(id==='sig_confirm'){
          append('user: [1] Connection is stable.','prompt');
          append('admin1: Good… good… then the relay still trusts you. Keep that link alive. It may be the last path out.', null);
        } else if(id==='sig_ask'){
          append('user: [2] What happened to him?','prompt');
          append('admin1: They found the hidden channel I used to reach you. They tore the antenna from the roof. I ran. Now I’m beneath the old reactor vault — the air tastes of metal and snow.', null);
        } else {
          append('user: [3] (silent)','prompt');
          append('admin1: You listen well. That’s rare here. Every word costs power now… so I’ll make them count.', null);
        }
        append('admin1: Fragment Transmission — The Clue', null);
        append('admin1: I stored a failsafe packet inside the Bhutan DNS cache. If you can pull it, you’ll see what they hid.', null);
        append('admin1: Type the command: open signal.cache --sector Δ-47', 'muted');
      });
    }

    async function openSignalCache(){
      append('>>> open signal.cache --sector Δ-47','prompt');
      append('SYSTEM: Decrypting fragment Δ-47...', 'muted'); await waitMs(900);
      append('SYSTEM: Recovered Data (3 lines):', 'muted');
      append('   [1] “PROJECT HELIOTROPE // Mt. Kharichai Core Stabilization Unit”', null);
      append('   [2] “Personnel Status: Admin1 – Missing Below Depth 900 m”', null);
      append('   [3] “Emergency Beacon Key = #SR-113-A”', null);
      append('admin1: You found it… the beacon key. If you activate it, the core will send a burst to every node linked to Bhutan’s network.', null);
      append('admin1: But the Watchers will see it too…', null);
      append('SYSTEM: Next available command: activate.beacon', 'muted');
    }

    async function activateBeacon(){
      append('>>> activate.beacon','prompt');
      append('SYSTEM: Local cache key found — #SR-113-A','muted');
      append('SYSTEM: Beacon control module: Locked — require confirmation.','muted');
      append('WARNING: Activating the beacon will broadcast a high-power burst across all Bhutan-linked nodes.','muted');
      append('Proceed? [Y/N]','muted');

      await presentChoices([
        {id:'beacon_yes', label:'Y'},
        {id:'beacon_mask', label:'[Mask origin: Wait & attempt to mask origin]'},
        {id:'beacon_abort', label:'N (Abort)'}
      ], async (bid)=>{
        if(bid==='beacon_yes'){
          append('user: Y','prompt'); append('SYSTEM: Initializing beacon sequence...','muted'); await waitMs(700);
          append('SYSTEM: Allocating power from backup capacitor bank — 42% — 68% — 100% ✓','muted'); await waitMs(600);
          append('SYSTEM: Opening secure channel to Bhutan relay for synchronized burst...','muted'); await waitMs(800);
          append('SYSTEM: Channel handshake: OK','muted'); append('SYSTEM: Beacon arm code accepted. Pending final trigger.','muted');
          append('admin1 (faint): If you do this... the sky will light like a wound. They won’t let it go unseen.', null);
          await presentChoices([
            {id:'trigger_now', label:'[1] Trigger beacon now'},
            {id:'trigger_mask', label:'[2] Wait & attempt to mask origin'},
            {id:'trigger_abort', label:'[3] Abort beacon'}
          ], async (trid)=>{
            if(trid==='trigger_now'){ append('user: Triggering beacon #SR-113-A — now.','prompt'); append('SYSTEM: Final trigger accepted.','muted'); await countdownAndBurst(); }
            else if(trid==='trigger_mask'){ append('user: Masking origin — initiating obfuscation routine...','prompt'); append('SYSTEM: Running relay obfuscation: route hopping through 5 mirrored nodes — OK','muted'); append('SYSTEM: Beacon queued; execution window extended', 'muted'); append('admin1: Good. You bought us time. Use it well.', null); }
            else { append('user: Abort. Saving key for later.','prompt'); append('SYSTEM: Beacon disarmed. Key #SR-113-A stored in secure cache.','muted'); append('admin1: You’re cautious. That might save more than it costs.', null); }
          });
        } else if(bid==='beacon_mask'){ append('user: Masking origin — initiating obfuscation routine...','prompt'); append('SYSTEM: Running relay obfuscation: route hopping through 5 mirrored nodes — OK','muted'); append('SYSTEM: Beacon queued; execution window extended', 'muted'); }
        else { append('user: Abort. Saving key for later.','prompt'); append('SYSTEM: Beacon disarmed. Key stored.', 'muted'); }
      });
    }

    async function countdownAndBurst(){
      append('SYSTEM: Emitting pulse in 3... 2... 1...','muted'); await waitMs(900);
      append('SYSTEM: BEACON BROADCAST: ███████████████ 100% — Signal propagation: OK','muted');
      append('SYSTEM: Replication handshake with Bhutan nodes: INITIATED','muted');
      append('admin1: (relieved) The caches are lighting up… I can see nodes responding… it’s working…', null);
      await playSound('static', {loop:true}); await waitMs(700); stopSound('static');
      append('[LOUD STATIC BURST — distant metal groan]','muted');
      append('SYSTEM: Intrusion detection — Watcher proximity alert: SECTOR NORTH SHAFT — 17 m','muted');
      append('admin1: They’re here. I have to move. Don’t stop— run the decode when you can— HELIOTROPE—', null);
      await playSound('static', {loop:true}); await waitMs(500); stopSound('static');
      append('SYSTEM: Emergency countermeasure initiated by Mt. Kharichai Control: NETWORK BLACKOUT — rolling.', 'muted');
      append('SYSTEM: Bhutan relay replication: partial mirror confirmed — 43% of files propagated.', 'muted');
      append('SYSTEM: Attempting reconnection to Admin1 — RETRY COUNT 1/5', 'muted');
      for(let i=1;i<=5;i++){ append(`SYSTEM: RECONNECTION ATTEMPT ${i} — ${i<3 ? 'FAILED (timeout)' : (i===3 ? 'FAILED (route hijacked)' : 'FAILED (EM interference)')}`, 'muted'); await waitMs(600 + Math.random()*300); }
      append('SYSTEM: ADMIN1 SIGNAL: LOST — BLOCKED', 'muted'); append('SYSTEM: STATUS: OPERATION FAILED', 'muted');
      await playSound('hangup'); append('>>> SYSTEM NOTICE:', 'muted'); append('Operation outcome: FAILURE', 'muted');
      append('Admin1 status: UNREACHABLE — last known location: Mt. Kharichai sub-shaft depth 915 m (unverified)', 'muted');
      append('Options:', 'muted'); append('[1] Save all recovered artifacts to secure archive', 'muted'); append('[2] Attempt emergency erase to remove traces (danger: legal/ethical implications)', 'muted'); append('[3] End session and exit (recommended)', 'muted');
      await presentChoices([{id:'save_artifacts',label:'[1] Save all recovered artifacts'},{id:'erase_artifacts',label:'[2] Emergency erase'},{id:'end_exit',label:'[3] End session & exit'}], async (opt)=> {
        if(opt==='save_artifacts'){ append('SYSTEM: Writing recovered files to /local/cache/secure/operation_kharichai/','muted'); await waitMs(700); append('SYSTEM: Files saved.','muted'); }
        else if(opt==='erase_artifacts'){ append('SYSTEM: Attempting emergency erase...','muted'); await waitMs(700); append('SYSTEM: Erase complete. Local traces removed.','muted'); }
        else { append('SYSTEM: Session closed. Goodbye.','muted'); }
      });
    }

    // progress bar helper
    async function progressBar(text, ms){
      const bar = document.createElement('div'); bar.className='line muted'; bar.textContent=text; adminLog.appendChild(bar); adminLog.scrollTop = adminLog.scrollHeight; await waitMs(ms);
    }

    // public handler
    async function handleCommand(raw){
      const cmd = (raw||'').trim();
      if(!cmd) return;
      const lc = cmd.toLowerCase();
      if(lc === 'call.admin1') await runCallAdmin1();
      else if(lc.startsWith('call.admin')) await runCallAdmin(); // generic
      else if(lc === 'retrieve.signal') await retrieveSignal();
      else if(lc.startsWith('open signal.cache')) await openSignalCache();
      else if(lc === 'activate.beacon') await activateBeacon();
      else if(lc === 'decode.heliotrope') { append('>>> decode.heliotrope','prompt'); await progressBar('Progress: ██████████ 100% ✓',900); append('SYSTEM: Output saved: heliotrope_readme.txt','muted'); append('Contents (excerpt): "Operation: Curtain — unauthorized experiments..."', null); }
      else { append('>>> ' + cmd,'prompt'); append('SYSTEM: Unknown admin command. Try: call.admin | call.admin1 | retrieve.signal | open signal.cache --sector Δ-47 | activate.beacon | decode.heliotrope','muted'); }
    }

    // Save / clear pressed (hooked outside)
    adminSaveLog.addEventListener('click', ()=>{
      const text = Array.from(adminLog.querySelectorAll('.line')).map(n=>n.textContent).join('\n');
      const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'admin_session_log.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    adminClearLog.addEventListener('click', ()=> adminLog.innerHTML='');
    adminRunBtn.addEventListener('click', ()=> { const txt = adminCmdInput.value.trim(); if(txt) { handleCommand(txt); adminCmdInput.value=''; } });
    adminCmdInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') adminRunBtn.click(); });

    return {
      handleCommand,
      enableAudio: enableAudio,
      append
    };
  })();

  // open / close admin modal
  function openAdminModal(){ adminModal.style.display = 'flex'; adminModal.setAttribute('aria-hidden','false'); adminSim.append('retro-cmdarg ready. Type `call.admin1` or `call.admin` to begin.','muted'); adminSim.append('Note: Click "Enable Audio" once to allow static / hangup sound playback.','muted'); }
  function closeAdminModal(){ adminModal.style.display = 'none'; adminModal.setAttribute('aria-hidden','true'); }
  document.getElementById('adminClose').addEventListener('click', closeAdminModal);

  // wire Admin enable / save / clear are handled inside adminSim

  /* Finally, expose adminSim.handleCommand for other code if needed */
  window.adminSim = adminSim;

})();
</script>
</body>
</html>
